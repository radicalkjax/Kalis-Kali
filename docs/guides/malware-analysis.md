# üî¨ Malware Analysis Guide

A comprehensive guide for safely analyzing malware using our containerized environment.

## ‚ö†Ô∏è Critical Safety Warning

```mermaid
graph TD
    A[MALWARE IS DANGEROUS] --> B[Can Destroy Data]
    A --> C[Can Steal Information]
    A --> D[Can Spread to Network]
    A --> E[Can Persist Forever]
    
    B --> F[USE ISOLATION]
    C --> F
    D --> F
    E --> F
    
    F --> G[Containers]
    F --> H[VMs]
    F --> I[Air-gapped Systems]
    
    style A fill:#ff1744,stroke:#b71c1c,stroke-width:4px,color:#fff
    style F fill:#ff9800,stroke:#e65100,stroke-width:3px,color:#fff
```

**NEVER analyze malware on:**
- Your primary computer
- Systems with important data
- Networks with other devices
- Without proper isolation

## üõ°Ô∏è Security Levels

```mermaid
graph LR
    subgraph "Choose Your Security Level"
        L1[Level 1: Static<br/>SAFEST]
        L2[Level 2: Dynamic<br/>MODERATE RISK]
        L3[Level 3: Sandbox<br/>HIGH RISK]
    end
    
    L1 --> S1[No Network<br/>Read-only FS<br/>No Execution]
    L2 --> S2[Isolated Net<br/>Monitoring<br/>Limited Exec]
    L3 --> S3[Honeypot<br/>Full Exec<br/>Auto-cleanup]
    
    style L1 fill:#4caf50,stroke:#2e7d32,stroke-width:3px
    style L2 fill:#ff9800,stroke:#f57c00,stroke-width:3px
    style L3 fill:#f44336,stroke:#c62828,stroke-width:3px
```

## üöÄ Getting Started

### Step 1: Prepare Your Environment

```bash
# Create malware directories (if not exist)
mkdir -p malware/samples malware/reports malware/captures

# Set restrictive permissions
chmod 700 malware/samples
chmod 755 malware/reports
```

### Step 2: Start Secure Environment

```mermaid
sequenceDiagram
    participant User
    participant Script
    participant Docker
    participant Container
    
    User->>Script: ./scripts/start-secure-malware-lab.sh
    Script->>User: Choose security level (1-3)
    User->>Script: Selection
    Script->>Docker: Start appropriate container
    Docker->>Container: Initialize with security settings
    Container->>Docker: Ready (isolated)
    Docker->>Script: Container ID
    Script->>User: Access instructions
    
    Note over Container: Network isolated<br/>Non-root user<br/>Resource limits
```

```bash
# Start the secure environment
./scripts/start-secure-malware-lab.sh

# Choose your level:
# 1 = Static Analysis (Recommended)
# 2 = Dynamic Analysis
# 3 = Full Sandbox (Dangerous)
```

### Step 3: Transfer Samples Safely

```bash
# Copy malware to analysis directory
# ALWAYS use .malware extension for safety
cp suspicious_file ./malware/samples/suspicious_file.malware

# Set read-only
chmod 444 ./malware/samples/suspicious_file.malware
```

## üìä Analysis Workflows

### 1. Static Analysis (Level 1)

```mermaid
graph TD
    A[Malware Sample] --> B[File Identification]
    B --> C[Hash Generation]
    C --> D[String Extraction]
    D --> E[Header Analysis]
    E --> F[YARA Scanning]
    F --> G[Report Generation]
    
    B --> |file command| B1[File Type]
    C --> |md5/sha256| C1[Unique Hashes]
    D --> |strings| D1[Embedded Text]
    E --> |objdump/readelf| E1[Structure]
    F --> |yara rules| F1[Pattern Match]
    
    style A fill:#ffcdd2,stroke:#d32f2f,stroke-width:2px
    style G fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
```

**Inside the container:**
```bash
# Access static analysis container
docker exec -it kali-malware-static /bin/bash

# Use automated analysis
/home/malware/safe-analyze.sh /samples/suspicious_file.malware

# Manual analysis
file /samples/suspicious_file.malware
strings -n 10 /samples/suspicious_file.malware | head -100
xxd /samples/suspicious_file.malware | head -50
```

### 2. Dynamic Analysis (Level 2)

```mermaid
graph LR
    subgraph "Behavioral Analysis"
        A[Execute in Container]
        A --> B[Monitor Syscalls]
        A --> C[Network Traffic]
        A --> D[File Operations]
        A --> E[Process Activity]
        
        B --> F[strace/ltrace]
        C --> G[tcpdump/wireshark]
        D --> H[inotify/auditd]
        E --> I[ps/top/htop]
    end
    
    style A fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
```

**Setup monitoring:**
```bash
# Terminal 1: Start network capture
docker exec -it malware-monitor /bin/sh
tcpdump -i eth0 -w /captures/malware_$(date +%s).pcap

# Terminal 2: Access dynamic container
docker exec -it kali-malware-dynamic /bin/bash

# Monitor system calls
strace -f -e trace=file,network,process ./malware 2>&1 | tee syscalls.log

# Monitor library calls
ltrace ./malware 2>&1 | tee libcalls.log
```

### 3. Advanced Techniques

```mermaid
mindmap
  root((Advanced Analysis))
    Unpacking
      UPX: upx -d
      Custom: x64dbg
      Entropy: binwalk
    Deobfuscation
      Strings: FLOSS
      Scripts: de4dot
      Macros: olevba
    Memory Analysis
      Dumps: volatility3
      Strings: strings -e l
      Injections: hollows_hunter
    Network
      DNS: dnspy
      HTTP: mitmproxy
      C2: fakenet
```

## üîç Analysis Tools

### Static Analysis Arsenal

| Tool | Purpose | Usage |
|------|---------|-------|
| `file` | Identify file type | `file malware.exe` |
| `strings` | Extract text | `strings -n 8 malware.exe` |
| `hexdump` | View hex/ASCII | `hexdump -C malware.exe \| less` |
| `binwalk` | Find embedded files | `binwalk -e malware.exe` |
| `yara` | Pattern matching | `yara rules.yar malware.exe` |
| `objdump` | Disassemble | `objdump -d malware.exe` |
| `readelf` | ELF analysis | `readelf -a malware.elf` |
| `pescan` | PE analysis | `pescan malware.exe` |

### Dynamic Analysis Tools

| Tool | Purpose | Usage |
|------|---------|-------|
| `strace` | System calls | `strace -f ./malware` |
| `ltrace` | Library calls | `ltrace ./malware` |
| `gdb` | Debugging | `gdb ./malware` |
| `tcpdump` | Network capture | `tcpdump -i any -w out.pcap` |
| `wireshark` | Packet analysis | `wireshark out.pcap` |
| `ps` | Process monitoring | `ps aux \| grep malware` |
| `lsof` | Open files | `lsof -p PID` |

## üìù Analysis Workflow

```mermaid
stateDiagram-v2
    [*] --> Triage: New Sample
    Triage --> Static: Safe Analysis
    Triage --> Dynamic: Behavioral Needed
    
    Static --> Hashing: Generate Hashes
    Hashing --> Strings: Extract Strings
    Strings --> Structure: Analyze Structure
    Structure --> Patterns: YARA Scan
    Patterns --> Report: Generate Report
    
    Dynamic --> Snapshot: Create Snapshot
    Snapshot --> Execute: Run Malware
    Execute --> Monitor: Capture Behavior
    Monitor --> Analyze: Analyze Results
    Analyze --> Report: Generate Report
    
    Report --> [*]: Complete
    
    note right of Static: No execution<br/>Safest method
    note right of Dynamic: Controlled execution<br/>More risky
```

## üß™ Sample Analysis

### Example: Analyzing a Suspicious PE File

```bash
# 1. Initial Triage
docker exec -it kali-malware-static /bin/bash

# Basic info
file /samples/suspicious.exe
# Output: PE32 executable (GUI) Intel 80386, for MS Windows

# 2. Generate hashes
md5sum /samples/suspicious.exe    # 5d41402abc4b2a76b9719d911017c592
sha256sum /samples/suspicious.exe  # e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855

# 3. Extract strings
strings -n 10 /samples/suspicious.exe | grep -E "(http|ftp|cmd|powershell|registry)"
# Output: 
# http://malicious-site.com/payload
# cmd.exe /c whoami
# HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run

# 4. Check for packers
strings /samples/suspicious.exe | grep -i upx
# Output: UPX!

# 5. Unpack if needed
upx -d /samples/suspicious.exe -o /tmp/unpacked.exe

# 6. Deeper analysis on unpacked
strings /tmp/unpacked.exe | grep -i "password\|login\|steal"
```

## üõ†Ô∏è YARA Rules

### Setting Up YARA Rules

```bash
# Inside container
cd ~/malware-analysis
./setup-malware-analysis.sh  # Downloads rule repos

# Use YARA
yara -r ~/malware-analysis/yara-rules/rules.yar /samples/malware.exe
```

### Custom YARA Rule Example

```yara
rule Suspicious_Strings
{
    meta:
        description = "Detects suspicious strings"
        author = "Security Team"
        date = "2025-01-01"
    
    strings:
        $a = "cmd.exe" nocase
        $b = "powershell" nocase
        $c = "bypass" nocase
        $d = "hidden" nocase
        $e = /https?:\/\/[a-z0-9]{6,10}\.(tk|ml|ga)/
        
    condition:
        2 of them
}
```

## üìä Reporting

### Report Template

```markdown
# Malware Analysis Report

## File Information
- **Filename**: suspicious.exe
- **MD5**: 5d41402abc4b2a76b9719d911017c592
- **SHA256**: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
- **File Type**: PE32 executable
- **Size**: 125,440 bytes

## Static Analysis
- **Packer**: UPX 3.96
- **Suspicious Strings**: 
  - C2 Server: http://malicious-site.com
  - Commands: cmd.exe, powershell -bypass
- **Imports**: WinHTTP, CreateProcess, RegSetValue

## Behavioral Analysis
- **Network**: Connects to 192.168.1.100:8080
- **Filesystem**: Creates C:\Windows\Temp\update.exe
- **Registry**: HKCU\Software\Microsoft\Windows\CurrentVersion\Run
- **Processes**: Spawns cmd.exe with elevated privileges

## Indicators of Compromise (IOCs)
- **URLs**: http://malicious-site.com/payload
- **IPs**: 192.168.1.100
- **Files**: C:\Windows\Temp\update.exe
- **Registry**: HKCU\Software\Microsoft\Windows\CurrentVersion\Run\Update

## Classification
**Verdict**: Trojan.Generic.Downloader
**Risk Level**: High
```

## üö® Emergency Procedures

```mermaid
graph TD
    A[Suspected Escape] --> B[IMMEDIATELY]
    B --> C[Disconnect Network]
    B --> D[Kill All Containers]
    B --> E[Do NOT Shutdown]
    
    C --> F[Physical Cable/WiFi]
    D --> G[docker kill $(docker ps -q)]
    E --> H[Preserve Memory]
    
    F --> I[Incident Response]
    G --> I
    H --> I
    
    I --> J[Scan System]
    I --> K[Check Processes]
    I --> L[Review Logs]
    
    style A fill:#ff1744,stroke:#d50000,stroke-width:4px
    style B fill:#ff5252,stroke:#d50000,stroke-width:3px
    style I fill:#ff9800,stroke:#f57c00,stroke-width:2px
```

## üìö Best Practices

1. **Always use the secure containers** - Never the standard one
2. **One sample at a time** - Don't analyze multiple simultaneously
3. **Document everything** - Keep detailed notes
4. **Hash before and after** - Verify file integrity
5. **Network isolation** - Always verify before running
6. **Time limits** - Set maximum analysis time
7. **Clean environment** - Fresh container for each sample
8. **Backup first** - Before any analysis

## üîó Additional Resources

- [Malware Bazaar](https://bazaar.abuse.ch/) - Malware samples
- [Hybrid Analysis](https://www.hybrid-analysis.com/) - Online sandbox
- [Any.run](https://any.run/) - Interactive sandbox
- [VirusTotal](https://www.virustotal.com/) - Multi-AV scanning
- [MalAPI.io](https://malapi.io/) - API documentation
- [MITRE ATT&CK](https://attack.mitre.org/) - Tactics database

---

**Remember: When in doubt, DON'T execute! Static analysis is always safer.**