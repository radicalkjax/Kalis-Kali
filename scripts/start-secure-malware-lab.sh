#!/bin/bash

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë          SECURE MALWARE ANALYSIS LAB - MAXIMUM ISOLATION     ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""
echo "üõ°Ô∏è  This starts a SECURE malware analysis environment with:"
echo "   ‚Ä¢ Complete network isolation"
echo "   ‚Ä¢ Non-root user execution"
echo "   ‚Ä¢ Read-only filesystem"
echo "   ‚Ä¢ Resource limits"
echo "   ‚Ä¢ No privileged access"
echo ""
echo "‚ö†Ô∏è  WARNING: Even with these protections, malware analysis is dangerous!"
echo "‚ö†Ô∏è  Only run on isolated systems with proper backups!"
echo ""

# Safety check
if [ "$EUID" -eq 0 ]; then 
   echo "‚ùå ERROR: Do not run as root! Use a regular user account."
   exit 1
fi

# Check Docker daemon
if ! docker info >/dev/null 2>&1; then
    echo "‚ùå ERROR: Docker daemon is not running or accessible"
    exit 1
fi

read -p "Do you understand the risks and want to continue? (type 'I UNDERSTAND'): " response
if [[ "$response" != "I UNDERSTAND" ]]; then
    echo "Aborted. Good choice - safety first!"
    exit 1
fi

echo ""
echo "[*] Creating secure directories..."
mkdir -p malware-samples malware-reports captures sandbox-output
chmod 755 malware-samples malware-reports
chmod 700 captures sandbox-output

echo "[*] Building secure malware analysis image..."
docker build -f Dockerfile.malware-secure -t kali-malware-secure:latest .

echo "[*] Starting secure analysis environment..."
echo ""
echo "Choose analysis level:"
echo "1) Static Analysis (safest - no network, read-only)"
echo "2) Dynamic Analysis (moderate risk - isolated network)"
echo "3) Full Sandbox (dangerous - use with extreme caution)"
echo ""
read -p "Select option (1-3): " level

case $level in
    1)
        echo "[*] Starting static analysis container..."
        docker-compose -f docker-compose.malware-secure.yml up -d kali-malware-static
        echo ""
        echo "‚úÖ Static analysis environment ready!"
        echo ""
        echo "Access with:"
        echo "  docker exec -it kali-malware-static /bin/bash"
        echo ""
        echo "Features:"
        echo "  ‚Ä¢ Complete network isolation"
        echo "  ‚Ä¢ Read-only root filesystem"
        echo "  ‚Ä¢ Non-root user (uid 1000)"
        echo "  ‚Ä¢ 2GB memory limit"
        echo "  ‚Ä¢ Samples in /samples (read-only)"
        echo "  ‚Ä¢ Reports in /reports (writable)"
        ;;
    2)
        echo "[*] Starting dynamic analysis container..."
        docker-compose -f docker-compose.malware-secure.yml up -d kali-malware-dynamic malware-monitor
        echo ""
        echo "‚ö†Ô∏è  Dynamic analysis environment ready!"
        echo ""
        echo "Access with:"
        echo "  docker exec -it kali-malware-dynamic /bin/bash"
        echo ""
        echo "Features:"
        echo "  ‚Ä¢ Isolated internal network only"
        echo "  ‚Ä¢ Non-root user (uid 1000)"
        echo "  ‚Ä¢ 4GB memory limit"
        echo "  ‚Ä¢ Network capture in ./captures/"
        echo "  ‚Ä¢ Limited syscalls (seccomp)"
        ;;
    3)
        echo "‚ö†Ô∏è  EXTREME CAUTION: Sandbox mode selected!"
        read -p "Are you REALLY sure? (type 'YES SANDBOX'): " confirm
        if [[ "$confirm" != "YES SANDBOX" ]]; then
            echo "Aborted."
            exit 1
        fi
        echo "[*] Starting sandbox environment..."
        docker-compose -f docker-compose.malware-secure.yml up -d kali-malware-sandbox malware-monitor
        echo ""
        echo "üî¥ SANDBOX ACTIVE - EXTREME CAUTION!"
        echo ""
        echo "Access with:"
        echo "  docker exec -it kali-malware-sandbox /bin/bash"
        echo ""
        echo "Auto-cleanup in 30 minutes!"
        # Schedule cleanup
        (sleep 1800 && docker-compose -f docker-compose.malware-secure.yml down kali-malware-sandbox && echo "Sandbox auto-cleaned") &
        ;;
    *)
        echo "Invalid option"
        exit 1
        ;;
esac

echo ""
echo "üìù Usage tips:"
echo "  ‚Ä¢ Place malware samples in ./malware-samples/"
echo "  ‚Ä¢ Use /home/malware/safe-analyze.sh for automated analysis"
echo "  ‚Ä¢ Reports saved to ./malware-reports/"
echo "  ‚Ä¢ Network captures in ./captures/ (if applicable)"
echo ""
echo "To stop all containers:"
echo "  docker-compose -f docker-compose.malware-secure.yml down"
echo ""
echo "üõ°Ô∏è  Remember: This is a security tool - use responsibly!"