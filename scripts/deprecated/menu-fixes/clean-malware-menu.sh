#!/bin/bash
# Clean up all malware menu entries from the container

echo "Cleaning up all malware menu entries..."

# Check if container is running
if ! docker ps | grep -q kali-workspace; then
    echo "Error: kali-workspace container is not running"
    echo "Start it with: docker-compose up -d kali"
    exit 1
fi

# Clean up inside the container
docker exec kali-workspace bash << 'EOCLEAN'
echo "Removing all malware-related menu configurations..."

# Remove desktop files
rm -f /usr/share/applications/*malware*.desktop 2>/dev/null
rm -f /usr/local/share/applications/*malware*.desktop 2>/dev/null
rm -f /root/.local/share/applications/*malware*.desktop 2>/dev/null
rm -f /home/kali/.local/share/applications/*malware*.desktop 2>/dev/null

# Remove directory files
rm -f /usr/share/desktop-directories/*malware*.directory 2>/dev/null
rm -f /usr/local/share/desktop-directories/*malware*.directory 2>/dev/null
rm -f /root/.local/share/desktop-directories/*malware*.directory 2>/dev/null
rm -f /home/kali/.local/share/desktop-directories/*malware*.directory 2>/dev/null

# Remove any custom menu files
rm -rf /root/.config/menus/* 2>/dev/null
rm -rf /home/kali/.config/menus/* 2>/dev/null
rm -rf /etc/xdg/menus/applications-merged/*malware* 2>/dev/null
rm -rf /root/.config/menus/applications-merged/*malware* 2>/dev/null
rm -rf /home/kali/.config/menus/applications-merged/*malware* 2>/dev/null

# Clear ALL menu caches
rm -rf /root/.cache/menus/* 2>/dev/null
rm -rf /root/.cache/xfce4/* 2>/dev/null
rm -rf /home/kali/.cache/menus/* 2>/dev/null
rm -rf /home/kali/.cache/xfce4/* 2>/dev/null
rm -rf /var/cache/menus/* 2>/dev/null

# Update databases
update-desktop-database /usr/share/applications 2>/dev/null || true
update-desktop-database /usr/local/share/applications 2>/dev/null || true
xdg-desktop-menu forceupdate 2>/dev/null || true

# Restart panel to ensure changes take effect
pkill xfce4-panel 2>/dev/null || true
sleep 2

echo "Cleanup complete. All malware menu entries have been removed."
echo "You may need to restart the desktop or log out/in for changes to take full effect."
EOCLEAN

echo "Menu cleanup finished."