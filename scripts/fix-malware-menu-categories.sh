#!/bin/bash
# Fix the malware analysis menu categories

echo "Fixing malware analysis menu categories..."

docker exec -u kali kali-workspace bash -c '
# Remove broken malware desktop files
echo "Removing broken desktop files..."
rm -f /usr/share/applications/*-malware.desktop

# Recreate with proper Kali category format
echo "Creating properly categorized desktop files..."

# Ghidra - Reverse Engineering (07)
cat > /usr/share/applications/kali-ghidra-malware.desktop <<EOF
[Desktop Entry]
Name=Ghidra (Malware Analysis)
Comment=NSA Reverse Engineering Tool
Exec=/usr/bin/ghidra
Icon=ghidra
Terminal=false
Type=Application
Categories=X-Kali-07-ReverseEngineering;
EOF

# Cutter - Reverse Engineering (07)
cat > /usr/share/applications/kali-cutter-malware.desktop <<EOF
[Desktop Entry]
Name=Cutter (Malware Analysis)
Comment=Radare2 GUI
Exec=/usr/bin/cutter
Icon=cutter
Terminal=false
Type=Application
Categories=X-Kali-07-ReverseEngineering;
EOF

# Volatility3 - Forensics (15)
cat > /usr/share/applications/kali-volatility3-malware.desktop <<EOF
[Desktop Entry]
Name=Volatility3 (Memory Forensics)
Comment=Memory Forensics Framework
Exec=xfce4-terminal --hold -e volatility3
Icon=applications-forensics
Terminal=false
Type=Application
Categories=X-Kali-15-Forensics;
EOF

# YARA - Forensics (15)
cat > /usr/share/applications/kali-yara-malware.desktop <<EOF
[Desktop Entry]
Name=YARA (Pattern Matching)
Comment=Pattern Matching Engine
Exec=xfce4-terminal --hold -e "yara --help"
Icon=application-x-executable
Terminal=false
Type=Application
Categories=X-Kali-15-Forensics;
EOF

# Wireshark - Sniffing & Spoofing (04)
cat > /usr/share/applications/kali-wireshark-malware.desktop <<EOF
[Desktop Entry]
Name=Wireshark (Network Analysis)
Comment=Network Protocol Analyzer
Exec=/usr/bin/wireshark
Icon=wireshark
Terminal=false
Type=Application
Categories=X-Kali-04-SniffingSpoofing;
EOF

# Binwalk - Reverse Engineering (07)
cat > /usr/share/applications/kali-binwalk-malware.desktop <<EOF
[Desktop Entry]
Name=Binwalk (Firmware Analysis)
Comment=Firmware Analysis Tool
Exec=xfce4-terminal --hold -e "binwalk -h"
Icon=system-search
Terminal=false
Type=Application
Categories=X-Kali-07-ReverseEngineering;
EOF

# Update desktop database
update-desktop-database /usr/share/applications/

# Clear menu caches
rm -rf ~/.cache/menus/*
rm -rf ~/.cache/xfce4/*

# Restart panel to reload menu
xfce4-panel -r

echo "Menu categories fixed!"
echo "Tools are now in proper Kali categories:"
echo "- 04 - Sniffing & Spoofing (Wireshark)"
echo "- 07 - Reverse Engineering (Ghidra, Cutter, Binwalk)"
echo "- 15 - Forensics (Volatility3, YARA)"
'

echo ""
echo "Malware menu categories have been fixed!"
echo "The Whisker menu should now work properly."